<!DOCTYPE html>
<html ng-app="qTasksApp">
<head>
    <title>QTasks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="public/js/angular.min.js" type="text/javascript"></script>
    <script src="public/js/angular-resource.min.js" type="text/javascript"></script>
    <script src="public/js/underscore-min.js" type="text/javascript"></script>
    <script src="public/js/jquery.min.js"></script>
    <script src="public/js/bootstrap.min.js"></script>
    <script src="http://connect.facebook.net/en_US/all.js"></script>
    <script src="public/js/facebook-connect.js"></script>

    <link href="public/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="public/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">

    <style>
        body {
            padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
        }
    </style>
    <script>

        var taskModule = angular.module('taskServices', ['ngResource'])
                .factory('Task', ['$resource', function ($resource) {
                    var Task = $resource('/api/677830765/tasks/:taskId', {}, {
                        update: { method: 'PUT'}
                    });
                    return Task;
                }])
                .run(function ($rootScope, $location) {
                    $rootScope.$on("$routeChangeStart", function (event, next, current) {
                        if ($rootScope.oauthToken == null) {
                            if (!(next.templateUrl == "public/templates/signin.html")) {
                                $location.path("/signin");
                            }
                        }
                    })
                });

        var qTasksApp = angular.module('qTasksApp', ['taskServices'], function ($routeProvider) {
            $routeProvider
                    .when('/signin', {templateUrl: 'public/templates/signin.html', controller: SignInController})
                    .when('/dashboard', {templateUrl: 'public/templates/dashboard.html', controller: TaskListController})
                    .when('/settings', {templateUrl: 'public/templates/settings.html', controller: SettingsController})
                    .otherwise({redirectTo: '/signin'});

        });

        function SignInController($scope, $location, $rootScope) {

            $scope.$on('$viewContentLoaded', function () {
                if ($rootScope.fbInitCalled == null) {
                    facebookConnect.init(function () {

                        facebookConnect.getUsername(function (name) {
                            console.log("Name: " + name);
                            $rootScope.name = name;
                        });

                        $rootScope.fbInitCalled = true;

                    });
                }
            });

            $scope.signIn = function () {
                facebookConnect.getOAuth(function (oauth) {
                    console.log("OAuth: " + oauth);
                    $rootScope.oauthToken = oauth;
                    $location.path('/dashboard');
                });
            }

            $scope.signOut = function () {
                console.log("signing out!");
                $rootScope.oauthToken = null;
            }

            $scope.isSignedIn = function () {
                return $rootScope.oauthToken != null;
            }
        }

        function SettingsController($scope) {

        }


        function TaskListController($scope, Task) {
            $scope.tasks = Task.query(function () {
                $scope.cachedTasks = angular.copy($scope.tasks);
            });

            $scope.selectTask = function (id) {
                console.log("Selected task: " + id);
                $scope.selectedTask = _.where($scope.tasks, {_id: id})[0];
                $('#taskModal').modal();
            }

            $scope.saveCurrentTask = function () {
                console.log("updating cached tasks");
                $scope.cachedTasks = angular.copy($scope.tasks);
                console.log("will be saving current task now");
                if ($scope.selectedTask._id == null) {
                    // new task
                    Task.save({}, $scope.selectedTask, function (data) {
                        $scope.tasks.push(data);
                    });
                }
                else {
                    // update existing task
                    Task.update({taskId: $scope.selectedTask._id}, $scope.selectedTask, function (data) {
                        console.log("saved");
                    });
                }
            }

            $scope.revertToCachedTasks = function () {
                console.log("reloading tasks");
                $scope.tasks = angular.copy($scope.cachedTasks);
            }

            $scope.newTask = function () {
                $scope.selectedTask = new Task();
                $scope.selectedTask.thisweek = false;  // default values
                $('#taskModal').modal();
            }

            $scope.completeTask = function (id) {
                console.log("completing task " + id);
                Task.delete({taskId: id}, function () {
                    $scope.revertToCachedTasks();
                });
            }


            var uniqueValues = function (key) {
                return _.chain($scope.tasks).sortBy(key).pluck(key).uniq().without('').value();
            }

            // Scope for projects
            $scope.projects = function () {
                return uniqueValues('project');
            }
            $scope.projectFilter = {};
            $scope.setProjectFilter = function (passedProject) {
                $scope.projectFilter = {project: passedProject};
            }

            // Scope for contexts
            $scope.contexts = function () {
                return uniqueValues('context');
            }
            $scope.contextFilter = {};
            $scope.setContextFilter = function (passedContext) {
                $scope.contextFilter = {context: passedContext};
            }

            // Scope for thisweek flag
            $scope.thisweeks = function () {
                return uniqueValues('thisweek');
            }
            $scope.thisweekFilter = {};
            $scope.setThisweekFilter = function (passedThisweek) {
                $scope.thisweekFilter = {thisweek: passedThisweek};
            }
        }

    </script>
</head>
<body>
<div id="fb-root"></div>

<div class="container" ng-controller="SignInController">

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="brand" href="#">QTasks</a>

                <div class="nav-collapse collapse">
                    <ul class="nav">
                        <li class="active"><a href="#/dashboard">Dashboard</a></li>
                        <li><a href="#/settings">Settings</a></li>
                        <li class="dropdown" ng-show="isSignedIn()">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" ng-model="rootScope">{{name}}<b class="caret"></b>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a href="#" ng-click="signOut()">Sign Out</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container">
    <ng-view></ng-view>
</div>

</body>
</html>
