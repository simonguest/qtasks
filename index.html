<!DOCTYPE html>
<html ng-app="qTasksApp">
<head>
<title>QTasks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="public/js/angular.min.js" type="text/javascript"></script>
<script src="public/js/angular-resource.min.js" type="text/javascript"></script>
<script src="public/js/underscore-min.js" type="text/javascript"></script>
<script src="public/js/jquery.min.js"></script>
<script src="public/js/bootstrap.min.js"></script>

<link href="public/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="public/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">

<style>
    body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
    }
</style>
<script>

// setup facebook authorization
/* facebookConnect.init(function(status){
 console.log("you should now be logged in: "+status);
 console.log("FBID: "+facebookConnect.id());

 });
 */


var taskModule = angular.module('taskServices', ['ngResource'])
        .factory('Task', ['$resource', function ($resource) {
            var Task = $resource('/api/677830765/tasks/:taskId', {}, {
                update: { method: 'PUT'}
            });
            return Task;
        }])
        .run(function($rootScope, $location){
            $rootScope.$on( "$routeChangeStart", function(event, next, current){
                if (!$rootScope.signedIn)
                {
                    if (!(next.templateUrl == "public/templates/login.html"))
                    {
                        $location.path("/login");
                    }
                }
            })
        });

var qTasksApp = angular.module('qTasksApp', ['taskServices'], function ($routeProvider) {
    $routeProvider
            .when('/login', {templateUrl: 'public/templates/login.html', controller: LoginController})
            .when('/dashboard', {templateUrl: 'public/templates/dashboard.html', controller: TaskListController})
            .when('/settings', {templateUrl: 'public/templates/settings.html', controller: SettingsController})
            .otherwise({redirectTo: '/login'});

});

/*qTasksApp.directive('facebook',function($http)
 {
 return{
 restrict:'A',
 scope:true,
 controller:function($scope, $attrs)
 {

 $scope.fbid = "677830765";

 FB.init({
 appId      : $attrs.facebook, // App ID
 channelUrl : '//localhost:3000/channel.html', // Channel File
 status     : true, // check login status
 cookie     : true, // enable cookies to allow the server to access the session
 xfbml      : true  // parse XFBML
 });

 console.log("init completed");

 FB.login(function(response) {
 console.log("logging in");
 if (response.authResponse) {
 console.log('FB.login connected');
 fetch();
 } else {
 console.log('FB.login cancelled');
 }
 }, { scope: 'email,read_stream' }
 );

 FB.api('/me', function(response){
 console.log(response.id);
 });


 (function(d){
 var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
 if (d.getElementById(id)) {return;}
 js = d.createElement('script'); js.id = id; js.async = true;
 js.src = "//connect.facebook.net/en_US/all.js";
 ref.parentNode.insertBefore(js, ref);
 }(document));

 function login() {
 FB.login(function(response) {
 if (response.authResponse) {
 console.log('FB.login connected');
 fetch();
 } else {
 console.log('FB.login cancelled');
 }
 }, { scope: 'email,read_stream' }
 );
 };

 function fetch() {
 $http.post('/facebook/fetch', $scope.auth
 ).success(function(data) {
 window.location.reload(true);
 $scope.fetch_status = data.status;
 }).error(function(data) {
 console.log('error: '+data);
 $scope.fetch_status = data.status;
 });
 }

 $scope.fetch = function() {
 if ($scope.login_status == 'connected') {
 console.log('fetch');
 fetch();
 } else {
 login();
 }
 };
 },
 link: function($scope, element, attrs, controller) {
 // Additional JS functions here

 console.log("this should be loading sync1");



 /*window.fbAsyncInit = function() {
 FB.init({
 appId      : attrs.facebook, // App ID
 channelUrl : '//localhost:3000/channel.html', // Channel File
 status     : true, // check login status
 cookie     : true, // enable cookies to allow the server to access the session
 xfbml      : true  // parse XFBML
 });

 // Additional init code here
 FB.getLoginStatus(function(response) {
 console.log('getLoginStatus');
 if (response.status === 'connected') {
 // connected
 scope.auth = response.authResponse;
 FB.api('/me', function(response){
 scope.fbid = response.id;
 scope.$apply();
 console.log(response.id);
 });
 } else if (response.status === 'not_authorized') {
 // not_authorized
 } else {
 // not_logged_in
 }
 scope.login_status = response.status;
 scope.$apply();
 });



 }; // end of fbAsyncInit

 console.log("this should be loading sync2");


 }
 }
 });*/

function HeaderController($scope, $rootScope) {
    $scope.signOut = function () {
        console.log("signing out!");
        $rootScope.signedIn = false;
    }

    $scope.isSignedIn = function () {
        return $rootScope.signedIn;
    }
}

function LoginController($scope, $location, $rootScope) {
    $scope.login = function () {
        console.log("logging in!");
        // validation here

        $location.path('/dashboard');
        $rootScope.signedIn = true;
    }
}

function SettingsController($scope)
{

}


function TaskListController($scope, Task) {
    $scope.tasks = Task.query(function () {
        $scope.cachedTasks = angular.copy($scope.tasks);
    });

    $scope.selectTask = function (id) {
        console.log("Selected task: " + id);
        $scope.selectedTask = _.where($scope.tasks, {_id: id})[0];
        $('#taskModal').modal();
    }

    $scope.saveCurrentTask = function () {
        console.log("updating cached tasks");
        $scope.cachedTasks = angular.copy($scope.tasks);
        console.log("will be saving current task now");
        if ($scope.selectedTask._id == null) {
            // new task
            Task.save({}, $scope.selectedTask, function (data) {
                $scope.tasks.push(data);
            });
        }
        else {
            // update existing task
            Task.update({taskId: $scope.selectedTask._id}, $scope.selectedTask, function (data) {
                console.log("saved");
            });
        }
    }

    $scope.revertToCachedTasks = function () {
        console.log("reloading tasks");
        $scope.tasks = angular.copy($scope.cachedTasks);
    }

    $scope.newTask = function () {
        $scope.selectedTask = new Task();
        $scope.selectedTask.thisweek = false;  // default values
        $('#taskModal').modal();
    }

    $scope.completeTask = function (id) {
        console.log("completing task " + id);
        Task.delete({taskId: id}, function () {
            $scope.revertToCachedTasks();
        });
    }


    var uniqueValues = function (key) {
        return _.chain($scope.tasks).sortBy(key).pluck(key).uniq().without('').value();
    }

    // Scope for projects
    $scope.projects = function () {
        return uniqueValues('project');
    }
    $scope.projectFilter = {};
    $scope.setProjectFilter = function (passedProject) {
        $scope.projectFilter = {project: passedProject};
    }

    // Scope for contexts
    $scope.contexts = function () {
        return uniqueValues('context');
    }
    $scope.contextFilter = {};
    $scope.setContextFilter = function (passedContext) {
        $scope.contextFilter = {context: passedContext};
    }

    // Scope for thisweek flag
    $scope.thisweeks = function () {
        return uniqueValues('thisweek');
    }
    $scope.thisweekFilter = {};
    $scope.setThisweekFilter = function (passedThisweek) {
        $scope.thisweekFilter = {thisweek: passedThisweek};
    }
}

</script>
</head>
<body>

<div class="container" ng-controller="HeaderController">

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="brand" href="#">QTasks</a>

                <div class="nav-collapse collapse">
                    <ul class="nav">
                        <li class="active"><a href="#/dashboard">Dashboard</a></li>
                        <li><a href="#/settings">Settings</a></li>
                        <li ng-show="isSignedIn()"><a href="#" ng-click="signOut()">Sign Out</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>


</div>


<div class="container">
    <ng-view></ng-view>
</div>

</body>
</html>
