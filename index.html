<!DOCTYPE html>
<html ng-app="qTasksApp">
<head>
    <title>QTasks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="http://code.angularjs.org/1.1.5/angular.min.js"></script>
    <script src="http://code.angularjs.org/1.1.5/angular-resource.min.js"></script>
    <script src="public/js/underscore-min.js" type="text/javascript"></script>
    <script src="public/js/jquery.min.js"></script>
    <script src="public/js/bootstrap.min.js"></script>
    <script src="http://connect.facebook.net/en_US/all.js"></script>

    <link href="public/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="public/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">

    <style>
        body {
            padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
        }
    </style>
    <script>

        var SIGNIN_TEMPLATE = "public/templates/signin.html";
        var SIGNIN_PATH = "/signin";
        var DASHBOARD_TEMPLATE = "public/templates/dashboard.html";
        var DASHBOARD_PATH = "/dashboard";
        var SETTINGS_TEMPLATE = "public/templates/settings.html";
        var SETTINGS_PATH = "/settings";

        var taskModule = angular.module('taskServices', ['ngResource'])
                .factory('Task', ['$resource', '$rootScope', function ($resource, $rootScope) {
                    var Task = $resource('/api/tasks/:taskId', {}, {
                        query: { method: 'GET', params: {}, isArray:true, headers: {Authorization:'Bearer '+$rootScope.oauthToken}},
                        save: { method: 'POST', params: {}, isArray:false, headers: {Authorization:'Bearer '+$rootScope.oauthToken}},
                        update: { method: 'PUT', params: {}, isArray:false, headers: {Authorization:'Bearer '+$rootScope.oauthToken}},
                        delete: {method: 'DELETE', params: {}, isArray:false, headers: {Authorization:'Bearer '+$rootScope.oauthToken}}
                    });
                    return Task;
                }])
                .run(function ($rootScope, $location) {
                    $rootScope.$on("$routeChangeStart", function (event, next, current) {
                        if ($rootScope.oauthToken == null) {
                            if (!(next.templateUrl == SIGNIN_TEMPLATE)) {
                                $location.path(SIGNIN_PATH);
                            }
                        }
                    })
                });

        var qTasksApp = angular.module('qTasksApp', ['taskServices'], function ($routeProvider) {
            $routeProvider
                    .when(SIGNIN_PATH, {templateUrl: SIGNIN_TEMPLATE, controller: FacebookSigninController})
                    .when(DASHBOARD_PATH, {templateUrl: DASHBOARD_TEMPLATE, controller: DashboardController})
                    .when(SETTINGS_PATH, {templateUrl: SETTINGS_TEMPLATE, controller: SettingsController})
                    .otherwise({redirectTo: SIGNIN_PATH});

        });

        function FacebookSigninController($scope, $location, $rootScope) {

            $scope.$on('$viewContentLoaded', function () {
                if ($rootScope.fbInitCalled == null) {

                    FB.init({
                        appId: '530788920290681', // App ID from the App Dashboard
                        channelUrl: 'http://localhost:3000/channel.html', // Channel File for x-domain communication
                        status: true, // check the login status upon init?
                        cookie: true, // set sessions cookies to allow your server to access the session?
                        xfbml: true,  // parse XFBML tags on this page?
                        oauth: true
                    });

                    $rootScope.fbInitCalled = true;
                }

                // auto sign in?
                FB.getLoginStatus(function (response) {
                    console.log(response.status);
                    if (response.status === 'connected') {
                        $scope.setLoginDetails();
                    }
                });

            });

            $scope.signIn = function () {

                FB.getLoginStatus(function (response) {
                    console.log(response.status);
                    if (response.status === 'connected') {
                        $scope.setLoginDetails();
                    }
                    else if (response.status == 'not_authorized') {
                        // set message to say need authorization
                    }
                    else {
                        // do login
                        FB.login(function(response){
                            if (response.authResponse)
                            {
                                console.log("Logged in.  Fetching your information.");
                                $scope.setLoginDetails();
                            }
                        });
                    }
                });
            }

            $scope.setLoginDetails = function () {
                FB.getLoginStatus(function (response) {
                    if (response.status === 'connected') {

                        $rootScope.oauthToken = response.authResponse.accessToken;

                        FB.api('/me', function(response){
                            $rootScope.name = response.name;
                            $location.path(DASHBOARD_PATH);
                            $scope.$apply();
                        });
                    }
                });
            }

            $scope.signOut = function () {
                console.log("signing out!");

                FB.logout(function() {
                    $rootScope.oauthToken = null;
                    $location.path(SIGNIN_PATH);
                    $scope.$apply();
                });
            }

            $scope.isSignedIn = function () {
                return $rootScope.oauthToken != null;
            }
        }

        function SettingsController($scope) {

        }


        function DashboardController($scope, Task) {
            $scope.tasks = Task.query(function () {
                $scope.cachedTasks = angular.copy($scope.tasks);
            });

            $scope.selectTask = function (id) {
                console.log("Selected task: " + id);
                $scope.selectedTask = _.where($scope.tasks, {_id: id})[0];
                $('#taskModal').modal();
            }

            $scope.saveCurrentTask = function () {
                console.log("updating cached tasks");
                $scope.cachedTasks = angular.copy($scope.tasks);
                console.log("will be saving current task now");
                if ($scope.selectedTask._id == null) {
                    // new task
                    Task.save({}, $scope.selectedTask, function (data) {
                        //$scope.reloadTasks();
                        console.log(data);
                        $scope.tasks.push(data);
                    });
                }
                else {
                    // update existing task
                    Task.update({taskId: $scope.selectedTask._id}, $scope.selectedTask, function (data) {
                        console.log("saved");
                    });
                }
            }

            $scope.revertToCachedTasks = function () {
                console.log("reverting to cached tasks");
                $scope.tasks = angular.copy($scope.cachedTasks);
            }

            $scope.reloadTasks = function () {
                console.log("reloading tasks");
                $scope.tasks = Task.query(function () {
                    $scope.cachedTasks = angular.copy($scope.tasks);
                });
            }

            $scope.newTask = function () {
                $scope.selectedTask = new Task();
                $scope.selectedTask.thisweek = false;  // default values
                $('#taskModal').modal();
            }

            $scope.showCompleteDialog = function (id) {
                $scope.selectedTask = _.where($scope.tasks, {_id: id})[0];
                $('#deleteTaskModal').modal();
            }

            $scope.completeTask = function (id) {
                console.log("completing task " + id);
                $scope.tbdTask = _.where($scope.tasks, {_id: id})[0];

                Task.delete({taskId: id}, function () {
                    $scope.tasks = _.without($scope.tasks, $scope.tbdTask);
                });
            }


            var uniqueValues = function (key) {
                return _.chain($scope.tasks).sortBy(key).pluck(key).uniq().without('').value();
            }

            // Scope for projects
            $scope.projects = function () {
                return uniqueValues('project');
            }
            $scope.projectFilter = {};
            $scope.setProjectFilter = function (passedProject) {
                $scope.projectFilter = {project: passedProject};
            }

            // Scope for contexts
            $scope.contexts = function () {
                return uniqueValues('context');
            }
            $scope.contextFilter = {};
            $scope.setContextFilter = function (passedContext) {
                $scope.contextFilter = {context: passedContext};
            }

            // Scope for thisweek flag
            $scope.thisweeks = function () {
                return uniqueValues('thisweek');
            }
            $scope.thisweekFilter = {};
            $scope.setThisweekFilter = function (passedThisweek) {
                $scope.thisweekFilter = {thisweek: passedThisweek};
            }
        }

    </script>
</head>
<body>
<div id="fb-root"></div>

<div class="container" ng-controller="FacebookSigninController">

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="brand" href="#/dashboard">QTasks</a>

                <div class="nav-collapse collapse">
                    <ul class="nav">
                        <li class="active"><a href="#/dashboard">Dashboard</a></li>
                        <li><a href="#/settings">Settings</a></li>
                        <li class="dropdown" ng-show="isSignedIn()">
                            <a class="dropdown-toggle" data-toggle="dropdown" ng-model="rootScope">{{name}}<b
                                    class="caret"></b>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a ng-click="signOut()">Sign Out</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container">
    <ng-view></ng-view>
</div>

</body>
</html>
